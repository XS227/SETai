<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>POS Connection Flow Demo</title>
<style>
  :root {
    --bg: #0b1120;
    --panel: #0f172a;
    --panel-soft: #111c34;
    --line: #253454;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --ok: #22c55e;
    --warn: #f59e0b;
    --err: #ef4444;
    --accent: #38bdf8;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    min-height: 100vh;
    background: radial-gradient(circle at top, #131f38, var(--bg));
    color: var(--text);
    font-family: Tahoma, "IRANSans", Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 16px;
  }
  .app-shell {
    width: min(980px, 100%);
    display: grid;
    gap: 14px;
  }
  .onboarding {
    background: rgba(7, 12, 24, 0.95);
    border: 1px solid #1f2a44;
    border-radius: 18px;
    padding: 18px;
    box-shadow: 0 20px 60px rgba(0,0,0,.4);
  }
  .onboarding h1 { margin: 0 0 8px; font-size: 22px; }
  .onboarding p { margin: 0 0 8px; color: var(--muted); }
  .welcome {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 12px;
    margin: 10px 0;
  }
  .step-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 1px solid #365082;
    border-radius: 999px;
    padding: 4px 12px;
    font-size: 12px;
    margin-bottom: 10px;
    background: #10203f;
  }
  .codes-preview {
    background: #060c19;
    border: 1px solid #223355;
    border-radius: 10px;
    padding: 8px;
    margin: 10px 0;
    font-size: 12px;
    line-height: 1.8;
  }
  .codes-preview .success { display: block; }
  .terminal {
    width: min(980px, 100%);
    background: rgba(7, 12, 24, 0.95);
    border: 1px solid #1f2a44;
    border-radius: 18px;
    padding: 14px;
    display: grid;
    gap: 12px;
    grid-template-columns: 1fr;
    box-shadow: 0 20px 60px rgba(0,0,0,.4);
  }
  .left, .right {
    background: var(--panel);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
  }
  .title {
    font-size: 18px;
    margin: 0 0 6px;
  }
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }
  .top-actions {
    display: flex;
    gap: 6px;
  }
  .icon-btn {
    border: 1px solid #2b3e66;
    background: #12203a;
    color: #dbeafe;
    border-radius: 8px;
    padding: 6px 8px;
    cursor: pointer;
    font-size: 12px;
  }
  .mode-pill {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid #2b3e66;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,.4);
  }
  .mode-pill.online { background: #22c55e; border-color: #166534; }
  .mode-pill.offline { background: #f59e0b; border-color: #92400e; }
  .subtitle {
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 10px;
  }
  .menu {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 10px;
  }
  .menu button {
    background: #14213d;
    color: var(--text);
    border: 1px solid #22365c;
    border-radius: 10px;
    padding: 9px;
    cursor: pointer;
    font-size: 13px;
  }
  .menu button.active { border-color: var(--accent); color: #dff6ff; background: #193055; }

  .card {
    background: var(--panel-soft);
    border: 1px solid #253454;
    border-radius: 12px;
    padding: 10px;
    margin-bottom: 10px;
  }
  .field { margin-bottom: 8px; }
  label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
  input, .readonly {
    width: 100%;
    background: #0a1328;
    color: var(--text);
    border: 1px solid #2b3e66;
    border-radius: 9px;
    padding: 9px;
    font-size: 14px;
  }
  input:focus { outline: 1px solid #3b82f6; }
  .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .btns { display:flex; gap:8px; flex-wrap: wrap; }
  .btn {
    border: none;
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer;
    color: #fff;
    font-size: 13px;
  }
  .primary { background: #2563eb; }
  .ok { background: #16a34a; }
  .neutral { background: #334155; }
  .warn { background: #b45309; }

  .pinpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    max-width: 260px;
  }
  .pinpad button {
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #314364;
    background: #12213d;
    color: #fff;
    cursor: pointer;
  }
  .pin { letter-spacing: 6px; font-size: 18px; min-height: 40px; display:flex; align-items:center; justify-content:center; }

  .balances {
    border-top: 1px dashed #2c3f66;
    margin-top: 8px;
    padding-top: 8px;
    font-size: 13px;
    line-height: 1.8;
  }

  .log-wrap { height: 560px; display:flex; flex-direction:column; }
  .log {
    margin-top: 8px;
    background: #060c19;
    border: 1px solid #223355;
    border-radius: 10px;
    padding: 10px;
    overflow: auto;
    flex: 1;
    font-size: 12px;
    line-height: 1.7;
  }
  .entry { margin-bottom: 4px; white-space: pre-wrap; }
  .info { color: #93c5fd; }
  .success { color: #86efac; }
  .warning { color: #fcd34d; }
  .error { color: #fca5a5; }
  .hidden { display: none; }

  .receipt {
    background: #fff;
    color: #000;
    direction: rtl;
    font-family: "Courier New", monospace;
    line-height: 1.6;
    padding: 16px;
  }


  .identity-layout {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 14px;
    align-items: start;
  }
  .identity-photo {
    background: #081126;
    border: 1px solid #2b3e66;
    border-radius: 10px;
    overflow: hidden;
    text-align: center;
  }
  .identity-photo img {
    width: 100%;
    display: block;
    object-fit: cover;
  }
  .identity-photo .caption {
    padding: 6px;
    color: #fca5a5;
    background: #1e293b;
    font-size: 12px;
  }
  .identity-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 12px;
    line-height: 1.9;
    font-size: 14px;
  }
  .identity-grid .wide { grid-column: 1 / -1; }

  .global-log {
    width: min(980px, 100%);
    background: rgba(7, 12, 24, 0.95);
    border: 1px solid #1f2a44;
    border-radius: 18px;
    padding: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.4);
    height: 320px;
  }

  @media (max-width: 900px) {
    .log-wrap { height: 280px; }
    .row2 { grid-template-columns: 1fr; }
    .menu { grid-template-columns: 1fr; }
    .btns .btn { width: 100%; }
    .pinpad { max-width: 100%; }
    .identity-layout { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="app-shell">
  <section class="onboarding" id="onboardingBox">
    <div class="step-indicator" id="stepIndicator">Step 1/5</div>
    <h1>Secure Core Banking Gateway</h1>
    <div class="welcome">
      <div>Ø¨Ù‡ Ù¾Ø±ØªØ§Ù„ Ø¨Ø§Ù†Ú© Ù…Ø±Ú©Ø²ÛŒ Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø§ÛŒØ±Ø§Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</div>
      <div>Ù„Ø·ÙØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø³ÛŒØ³ØªÙ… Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</div>
    </div>
    <p id="onboardingText">Ú©Ø¯ Û±Û± Ø±Ù‚Ù…ÛŒ ÙˆØ±ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø§ØªØµØ§Ù„ Ø§Ù…Ù† Ø¢ØºØ§Ø² Ø´ÙˆØ¯.</p>
    <div class="field">
      <label id="onboardingLabel">Ú©Ø¯ Û±Û± Ø±Ù‚Ù…ÛŒ ÙˆØ±ÙˆØ¯</label>
      <input id="onboardingInput" maxlength="11" placeholder="***********" />
    </div>
    <div class="codes-preview hidden" id="codesPreview">
      <span class="success">ISO Auth Code: 00-2A7-OK</span>
      <span class="success">Session Token: CBI-SECURE-LIVE-9912</span>
      <span class="success">Realtime Stream: ACTIVE</span>
    </div>
    <div class="btns">
      <button class="btn primary" id="onboardingNextBtn">Ø§Ø¯Ø§Ù…Ù‡</button>
    </div>
  </section>

  <div class="terminal hidden" id="terminalApp">
    <section class="left">
      <div class="topbar">
        <h2 class="title">ğŸ› Ù¾Ø§ÛŒØ§Ù†Ù‡ Ù¾ÙˆØ²</h2>
        <div class="top-actions">
          <button class="icon-btn" id="modeBtn" title="Ø§ØªØµØ§Ù„/Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ù¾ÙˆØ²">Connect</button>
          <button class="icon-btn" id="fullViewBtn" title="Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… ØµÙØ­Ù‡">â›¶ Full View</button>
        </div>
      </div>
      <div class="subtitle">ÙØ±Ø¢ÛŒÙ†Ø¯ Ø§ØªØµØ§Ù„ Ù¾ÙˆØ²ØŒ Ú†ÛŒÙ¾ Ùˆ Ù…Ú¯Ù†Øª + Ø§Ù†ØªÙ‚Ø§Ù„ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø³Ø§Ø¨</div>
      <div id="modeInfo" class="mode-pill offline" aria-label="offline"></div>

      <div class="menu">
        <button class="active" data-menu="transfer">ğŸ”„ Ø§Ù†ØªÙ‚Ø§Ù„</button>
        <button data-menu="balance">ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒÙ‡Ø§</button>
        <button data-menu="identity">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±</button>
      </div>

      <div id="transferPane" class="card">
        <div class="field">
          <label>Ù…Ø´Ø®ØµØ§Øª Ø­Ø³Ø§Ø¨ Ú¯ÛŒØ±Ù†Ø¯Ù‡ / Ù…Ù‚ØµØ¯</label>
          <input id="targetInput" placeholder="6037... ÛŒØ§ IRxxxxxxxxxxxxxxxxxxxxxxxx" />
        </div>
        <div class="row2">
          <div class="field">
            <label>Ù…Ø§Ù„Ú© Ù…Ù‚ØµØ¯</label>
            <div class="readonly" id="targetOwner">-</div>
          </div>
          <div class="field">
            <label>Ù…Ø¨Ù„Øº (Ø±ÛŒØ§Ù„)</label>
            <input id="amount" type="number" min="10000" step="10000" value="12500000" />
          </div>
        </div>
      </div>

      <div id="balancePane" class="card hidden">
        <strong>ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒÙ‡Ø§</strong>
        <div class="balances"><strong>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨:</strong> Û± Ù‡Ø²Ø§Ø± Ùˆ Û¸ÛµÛ° Ù…Ù„ÛŒÙˆÙ† Ø±ÛŒØ§Ù„</div>
        <div class="balances"><strong>Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡:</strong> Û¹Û³ ØªØ±ÛŒÙ„ÛŒÙˆÙ† Ùˆ Û¸Û¹Û³ Ù…Ù„ÛŒØ§Ø±Ø¯ Ùˆ Û¶Û·Û° Ù…Ù„ÛŒÙˆÙ† Ø±ÛŒØ§Ù„</div>
      </div>

      <div id="identityPane" class="card hidden">
        <div class="identity-layout">
          <div class="identity-photo">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Portrait_Placeholder.png/300px-Portrait_Placeholder.png" alt="Ø¹Ú©Ø³ Ú©Ø§Ø±Ø¨Ø±" />
            <div class="caption">ÙˆØ¶Ø¹ÛŒØª Ø­ÛŒØ§Øª: ÙÙˆØª Ø´Ø¯Ù‡</div>
          </div>
          <div class="identity-grid">
            <div class="wide"><strong>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</strong> Ø³ÛŒØ¯ Ø¬Ù„ÛŒÙ„ Ù‡Ø§Ø´Ù…ÛŒ Ù†ÛŒØ§</div>
            <div><strong>Ú©Ø¯ Ù…Ù„ÛŒ:</strong> ÛµÛ³Û°Û¹ÛµÛ²Û¶Û°Û¸Û°</div>
            <div><strong>Ù†Ø§Ù… Ù¾Ø¯Ø±:</strong> Ø³ÛŒØ¯Ù…Ø³ÛŒØ­</div>
            <div><strong>ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯:</strong> Û±Û³Û°Û¹/Û±Û±/Û²Ûµ</div>
            <div><strong>Ø¬Ù†Ø³ÛŒØª:</strong> Ù…Ø±Ø¯</div>
            <div><strong>Ø´Ù…Ø§Ø±Ù‡ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡:</strong> Û´Û´Û¶Û²</div>
            <div><strong>Ø³Ø±ÛŒØ§Ù„ Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡:</strong> Û´Û¶Û°Û´Û·Û¸ - (Û± / Û·Û²)</div>
            <div><strong>Ú©Ø¯ Ø´Ù‡Ø§Ø¨:</strong> Û±Û°Û°Û°Û°Û°ÛµÛ³Û¹Û°ÛµÛ²Û¶Û°Û¸Û±</div>
            <div><strong>Ø´Ù†Ø§Ø³Ù‡ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ø§Ø³ØªØ¹Ù„Ø§Ù…:</strong> Û°Û±Û°Û°Û³Û´Û²Û±</div>
            <div><strong>ØªØ§Ø±ÛŒØ® ÙÙˆØª:</strong> Û±Û´Û°Û²/Û±Û±/Û²Û²</div>
            <div class="wide"><strong>ØªØ§Ø±ÛŒØ® Ø¢Ø®Ø±ÛŒÙ† ØªØºÛŒÛŒØ±Ø§Øª:</strong> Û±Û´Û°Û³/Û±Û²/Û±Û±</div>
          </div>
        </div>
      </div>

      <div class="card">
        <label>ğŸ” ÙˆØ±ÙˆØ¯ PIN</label>
        <div class="readonly pin" id="pinView">----</div>
        <div class="pinpad" id="pinpad"></div>
      </div>

      <div class="btns">
        <button class="btn primary" id="runBtn">Ø´Ø±ÙˆØ¹ ØªØ±Ø§Ú©Ù†Ø´</button>
        <button class="btn ok" id="printBtn">ğŸ§¾ Ú†Ø§Ù¾ Ø±Ø³ÛŒØ¯</button>
        <button class="btn neutral" id="resetBtn">Reset</button>
      </div>
    </section>
  </div>

  <section class="global-log log-wrap">
    <h3 class="title" style="font-size:16px">ğŸ“œ Log Engine</h3>
    <div class="subtitle">Ø§ÛŒÙ† Ù„Ø§Ú¯ Ø§Ø² Ø§ÙˆÙ„ÛŒÙ† Ù‚Ø¯Ù… ØªØ§ Ù¾Ø§ÛŒØ§Ù† ÙØ±Ø¢ÛŒÙ†Ø¯ Ù‡Ù…ÛŒØ´Ù‡ Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª.</div>
    <div class="log" id="log"></div>
  </section>
</div>

<script>
  const targetInput = document.getElementById('targetInput');
  const amountInput = document.getElementById('amount');
  const targetOwner = document.getElementById('targetOwner');
  const pinView = document.getElementById('pinView');
  const logEl = document.getElementById('log');
  const modeBtn = document.getElementById('modeBtn');
  const modeInfo = document.getElementById('modeInfo');
  const fullViewBtn = document.getElementById('fullViewBtn');
  const onboardingBox = document.getElementById('onboardingBox');
  const terminalApp = document.getElementById('terminalApp');
  const onboardingInput = document.getElementById('onboardingInput');
  const onboardingLabel = document.getElementById('onboardingLabel');
  const onboardingText = document.getElementById('onboardingText');
  const onboardingNextBtn = document.getElementById('onboardingNextBtn');
  const stepIndicator = document.getElementById('stepIndicator');
  const codesPreview = document.getElementById('codesPreview');

  const sepahFullOwner = 'Ø³ÛŒØ¯ Ø¬Ù„ÛŒÙ„ Ù‡Ø§Ø´Ù…ÛŒ Ù†ÛŒØ§';

  const targetOwners = {
    '603799': 'Ø±Ø¶Ø§ Ù…Ø±Ø§Ø¯ÛŒ',
    '589210': sepahFullOwner,
    '627412': 'Ù†Ú¯ÛŒÙ† Ø§Ù…ÛŒÙ†ÛŒ',
    'IR': 'Ø­Ø³Ø§Ø¨ Ù…Ø±Ú©Ø²ÛŒ Ù¾Ø§ÛŒØ§/Ø³Ø§ØªÙ†Ø§'
  };

  let pin = '';
  let isOnline = false;
  let onlineIP = '';
  let onboardingStep = 1;
  const onboardingData = { accessCode: '', ip: '', nationalId: '', accountNo: '' };

  function appendLog(msg, type = 'info') {
    const div = document.createElement('div');
    div.className = `entry ${type}`;
    const t = new Date().toLocaleTimeString('fa-IR');
    div.textContent = `[${t}] ${msg}`;
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function detectTargetOwner(value) {
    const v = value.trim().replace(/\s/g, '');
    if (!v) return '-';
    if (v.startsWith('IR')) return targetOwners.IR;
    const key = v.slice(0, 6);
    return targetOwners[key] || 'Ù…Ø§Ù„Ú© Ù†Ø§Ù…Ø´Ø®Øµ (Ù‚Ø§Ø¨Ù„ ØªÙˆØ³Ø¹Ù‡)';
  }

  targetInput.addEventListener('input', () => {
    targetOwner.textContent = detectTargetOwner(targetInput.value);
  });

  function buildPinpad() {
    const pad = document.getElementById('pinpad');
    const keys = ['1','2','3','4','5','6','7','8','9','Ù¾Ø§Ú©','0','OK'];
    keys.forEach(k => {
      const b = document.createElement('button');
      b.textContent = k;
      b.onclick = () => {
        if (k === 'Ù¾Ø§Ú©') pin = '';
        else if (k === 'OK') appendLog(`PIN Confirmed => ${'*'.repeat(pin.length || 4)}`, pin.length === 4 ? 'success' : 'warning');
        else if (pin.length < 4) pin += k;
        pinView.textContent = (pin + '----').slice(0, 4).replace(/./g, 'â€¢');
      };
      pad.appendChild(b);
    });
  }

  async function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  async function runTransaction() {
    const dst = targetInput.value.trim();
    const amount = Number(amountInput.value || 0);

    if (!dst) return appendLog('Ø®Ø·Ø§: Ù…Ø´Ø®ØµØ§Øª Ø­Ø³Ø§Ø¨ Ú¯ÛŒØ±Ù†Ø¯Ù‡ / Ù…Ù‚ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', 'error');
    if (pin.length !== 4) return appendLog('Ø®Ø·Ø§: PIN Ø¨Ø§ÛŒØ¯ Û´ Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯ Ùˆ OK Ø²Ø¯Ù‡ Ø´ÙˆØ¯.', 'error');
    if (amount < 10000) return appendLog('Ø®Ø·Ø§: Ù…Ø¨Ù„Øº Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ Û±Û°,Û°Û°Û° Ø±ÛŒØ§Ù„ Ø¨Ø§Ø´Ø¯.', 'error');

    const tOwner = detectTargetOwner(dst);
    appendLog('--- Ø´Ø±ÙˆØ¹ Ø³Ù†Ø§Ø±ÛŒÙˆÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ ---', 'warning');
    appendLog(`Mode => ${isOnline ? `ONLINE @ ${onlineIP}` : 'OFFLINE'}`, isOnline ? 'success' : 'warning');
    appendLog('Ú©Ø§Ø±Øª Ù…Ø¨Ø¯Ø§ Ø§Ø­Ø±Ø§Ø² Ø´Ø¯ Ùˆ Ø´Ù…Ø§Ø±Ù‡ Ú©Ø§Ø±Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯.', 'info');
    appendLog(`Target Owner => ${tOwner}`, 'info');

    appendLog('TCP Handshake: SYN â†’', 'info');
    await sleep(800);
    appendLog('TCP Handshake: SYN-ACK â†', 'info');
    await sleep(800);
    appendLog('TCP Handshake: ACK â†’ (Connection Established)', 'success');

    appendLog('Auth: Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ISO8583 MTI 0200', 'info');
    await sleep(1200);
    appendLog('Auth: Ø¨Ø±Ø±Ø³ÛŒ PIN Block + CVV + ExpDate', 'info');
    await sleep(1200);
    appendLog('Auth Result: Approved (RC=00)', 'success');

    const delay = Math.floor(Math.random() * 8000) + 5000;
    appendLog(`Network Delay Simulation: ${Math.floor(delay/1000)}s / ØªØ§ 13 Ø«Ø§Ù†ÛŒÙ‡`, 'warning');
    await sleep(delay);

    appendLog(`Transaction Complete | Ù…Ø¨Ù„Øº: ${amount.toLocaleString('fa-IR')} Ø±ÛŒØ§Ù„`, 'success');
    appendLog('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨: Û± Ù‡Ø²Ø§Ø± Ùˆ Û¸ÛµÛ° Ù…Ù„ÛŒÙˆÙ† Ø±ÛŒØ§Ù„', 'success');
    appendLog('Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡: Û¹Û³ ØªØ±ÛŒÙ„ÛŒÙˆÙ† Ùˆ Û¸Û¹Û³ Ù…Ù„ÛŒØ§Ø±Ø¯ Ùˆ Û¶Û·Û° Ù…Ù„ÛŒÙˆÙ† Ø±ÛŒØ§Ù„', 'warning');
  }

  function printReceipt() {
    const dst = targetInput.value || '----';
    const toOwner = targetOwner.textContent || '-';
    const amount = Number(amountInput.value || 0).toLocaleString('fa-IR');

    const w = window.open('', '_blank', 'width=420,height=620');
    w.document.write(`
      <html lang="fa" dir="rtl"><head><title>Ø±Ø³ÛŒØ¯ ØªØ±Ø§Ú©Ù†Ø´</title></head>
      <body class="receipt">
        <h3 style="text-align:center">Ø±Ø³ÛŒØ¯ Ø§Ù†ØªÙ‚Ø§Ù„</h3>
        <hr>
        ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleString('fa-IR')}<br>
        Ú©Ø§Ø±Øª/Ø­Ø³Ø§Ø¨ Ù…Ù‚ØµØ¯: ${dst}<br>
        Ù…Ø§Ù„Ú© Ù…Ù‚ØµØ¯: ${toOwner}<br>
        Ù…Ø¨Ù„Øº: ${amount} Ø±ÛŒØ§Ù„<br>
        ÙˆØ¶Ø¹ÛŒØª: Ù…ÙˆÙÙ‚ (00)<br>
        Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ: ${Math.floor(Math.random()*9e11+1e11)}<br>
        <hr>
        Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø­Ø³Ø§Ø¨: Û± Ù‡Ø²Ø§Ø± Ùˆ Û¸ÛµÛ° Ù…Ù„ÛŒÙˆÙ† Ø±ÛŒØ§Ù„<br>
        Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡: Û¹Û³ ØªØ±ÛŒÙ„ÛŒÙˆÙ† Ùˆ Û¸Û¹Û³ Ù…Ù„ÛŒØ§Ø±Ø¯ Ùˆ Û¶Û·Û° Ù…Ù„ÛŒÙˆÙ† Ø±ÛŒØ§Ù„
      </body></html>
    `);
    w.document.close();
    w.focus();
    w.print();
    appendLog('Receipt popup opened for print.', 'success');
  }

  function resetAll() {
    targetInput.value = '';
    amountInput.value = 12500000;
    pin = '';
    pinView.textContent = '----';
    targetOwner.textContent = '-';
    appendLog('Reset Ú©Ø§Ù…Ù„ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.', 'warning');
  }

  function setModeUI() {
    modeInfo.setAttribute('aria-label', isOnline ? 'online' : 'offline');
    modeInfo.classList.toggle('online', isOnline);
    modeInfo.classList.toggle('offline', !isOnline);
    modeBtn.textContent = isOnline ? 'Disconnect' : 'Connect';
  }

  function updateOnboardingStep() {
    stepIndicator.textContent = `Step ${onboardingStep}/5`;
    onboardingInput.value = '';
    onboardingInput.classList.remove('hidden');
    onboardingNextBtn.textContent = 'Ø§Ø¯Ø§Ù…Ù‡';
    codesPreview.classList.toggle('hidden', onboardingStep < 5);

    if (onboardingStep === 1) {
      onboardingLabel.textContent = 'Ú©Ø¯ Û±Û± Ø±Ù‚Ù…ÛŒ ÙˆØ±ÙˆØ¯';
      onboardingText.textContent = 'Ú©Ø¯ Û±Û± Ø±Ù‚Ù…ÛŒ ÙˆØ±ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø§ØªØµØ§Ù„ Ø§Ù…Ù† Ø¢ØºØ§Ø² Ø´ÙˆØ¯.';
      onboardingInput.placeholder = '***********';
      onboardingInput.maxLength = 11;
    } else if (onboardingStep === 2) {
      onboardingLabel.textContent = 'IP Address';
      onboardingText.textContent = 'Ø¨Ø±Ø§ÛŒ Ø±ÙØªÙ† Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¢Ù†Ù„Ø§ÛŒÙ†ØŒ IP Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆØ± Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.';
      onboardingInput.placeholder = '185.30.22.110';
      onboardingInput.maxLength = 32;
    } else if (onboardingStep === 3) {
      onboardingLabel.textContent = 'Ù„Ø·ÙØ§ Ú©Ø¯ Ù…Ù„ÛŒ Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
      onboardingText.textContent = 'Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯. Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ø²Ù†Ø¯Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.';
      onboardingInput.placeholder = '**********';
      onboardingInput.maxLength = 10;
    } else if (onboardingStep === 4) {
      onboardingLabel.textContent = 'Ù„Ø·ÙØ§ Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
      onboardingText.textContent = 'Ø¨Ø±Ø§ÛŒ ÙˆØ§Ú©Ø´ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ù…ÙˆØŒ Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.';
      onboardingInput.placeholder = '603799xxxxxx';
      onboardingInput.maxLength = 24;
      onboardingInput.classList.remove('hidden');
      onboardingNextBtn.textContent = 'Ø§Ø¯Ø§Ù…Ù‡';
    } else if (onboardingStep === 5) {
      onboardingLabel.textContent = 'Ø§ØªØµØ§Ù„ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÙˆØ²';
      onboardingText.textContent = 'Ø¨Ø¹Ø¯ Ø§Ø² ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ØŒ Ø§ØªØµØ§Ù„ Ù¾ÙˆØ² Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯ Ùˆ Ø¯Ú©Ù…Ù‡ Connect Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.';
      onboardingInput.classList.add('hidden');
      onboardingNextBtn.textContent = 'Connect';
    }
  }

  async function completeOnboarding() {
    appendLog('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ù¾ÙˆØ² Ø«Ø¨Øª Ø´Ø¯.', 'info');
    appendLog('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾ÙˆØ²...', 'info');
    await sleep(1000);
    appendLog('Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ù¾ÙˆØ² Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ø¨Ø§Ù†Ú© Ù…Ø±Ú©Ø²ÛŒ...', 'info');
    await sleep(1400);
    appendLog('Ø³ÛŒÚ¯Ù†Ø§Ù„: Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± âœ…', 'success');
    appendLog('Ù„Ø·ÙØ§ Ú©Ø§Ø±Øª Ø±Ø§ Ø¯Ø± Ù‚Ø³Ù…Øª Ú†ÛŒÙ¾ Ù¾ÙˆØ² ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ù‡Ù„Øª Û±Ûµ Ø«Ø§Ù†ÛŒÙ‡).', 'warning');
    await sleep(15000);
    appendLog('Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ú†ÛŒÙ¾ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯.', 'success');
    appendLog('Ù„Ø·ÙØ§ Ú©Ø§Ø±Øª Ø¯ÙˆÙ… Ø±Ø§ Ø¯Ø± Ù‚Ø³Ù…Øª Ù…Ú¯Ù†Øª Ù¾ÙˆØ² Ø¨Ú©Ø´ÛŒØ¯.', 'warning');
    await sleep(2000);
    appendLog('Ø§ØªØµØ§Ù„ Ù…Ú¯Ù†Øª Ú©Ø§Ø±Øª Ø¯ÙˆÙ… ØªØ§ÛŒÛŒØ¯ Ø´Ø¯.', 'success');

    onboardingBox.classList.add('hidden');
    terminalApp.classList.remove('hidden');
    isOnline = true;
    onlineIP = onboardingData.ip;
    setModeUI();

    targetInput.value = onboardingData.accountNo;
    targetOwner.textContent = detectTargetOwner(targetInput.value);

    document.querySelector('[data-menu="identity"]').click();
    appendLog(`Login accepted by gateway (11-digit code): ${'*'.repeat(onboardingData.accessCode.length)}`, 'success');
    appendLog(`Online bridge active on IP: ${onboardingData.ip}`, 'success');
    appendLog(`National ID captured: ${onboardingData.nationalId}`, 'info');
    appendLog(`Account number validated: ${onboardingData.accountNo}`, 'success');
    appendLog('Ù…Ø´Ø®ØµØ§Øª Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù…ÙˆØ¬ÙˆØ¯ÛŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.', 'success');
  }

  async function nextOnboardingStep() {
    const value = onboardingInput.value.trim();
    if (onboardingStep === 1) {
      if (!/^\d{11}$/.test(value)) return appendLog('ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±: Ú©Ø¯ Ø¨Ø§ÛŒØ¯ Û±Û± Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯.', 'error');
      onboardingData.accessCode = value;
    } else if (onboardingStep === 2) {
      if (!/^((25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(25[0-5]|2[0-4]\d|[01]?\d\d?)$/.test(value)) {
        return appendLog('IP Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø±Ø³Øª: 185.30.22.110', 'error');
      }
      onboardingData.ip = value;
    } else if (onboardingStep === 3) {
      if (!/^\d{10}$/.test(value)) return appendLog('Ú©Ø¯ Ù…Ù„ÛŒ Ø¨Ø§ÛŒØ¯ Û±Û° Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯.', 'error');
      onboardingData.nationalId = value;
    } else if (onboardingStep === 4) {
      if (value.length < 10) return appendLog('Ø´Ù…Ø§Ø±Ù‡ Ø­Ø³Ø§Ø¨ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.', 'error');
      onboardingData.accountNo = value;
    } else if (onboardingStep === 5) {
      onboardingStep = 6;
      return completeOnboarding();
    }

    onboardingStep += 1;
    updateOnboardingStep();
  }

  function toggleMode() {
    if (!isOnline) {
      isOnline = true;
      onlineIP = onboardingData.ip || '185.30.22.110';
      appendLog(`Ù¾ÙˆØ² Ø¢Ù†Ù„Ø§ÛŒÙ† Ø´Ø¯. IP: ${onlineIP}`, 'success');
    } else {
      isOnline = false;
      onlineIP = '';
      appendLog('Ù¾ÙˆØ² Ø¢ÙÙ„Ø§ÛŒÙ† Ø´Ø¯.', 'warning');
    }
    setModeUI();
  }

  async function toggleFullView() {
    try {
      if (!document.fullscreenElement) {
        await document.documentElement.requestFullscreen();
        appendLog('Full view enabled.', 'info');
      } else {
        await document.exitFullscreen();
        appendLog('Full view disabled.', 'info');
      }
    } catch (e) {
      appendLog('Fullscreen failed in this environment.', 'error');
    }
  }

  document.querySelectorAll('.menu button').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.menu button').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');
      const m = btn.dataset.menu;
      document.getElementById('transferPane').classList.toggle('hidden', m !== 'transfer');
      document.getElementById('balancePane').classList.toggle('hidden', m !== 'balance');
      document.getElementById('identityPane').classList.toggle('hidden', m !== 'identity');
      appendLog(`Menu changed => ${m}`, 'info');
    };
  });

  document.getElementById('runBtn').onclick = runTransaction;
  document.getElementById('printBtn').onclick = printReceipt;
  document.getElementById('resetBtn').onclick = resetAll;
  modeBtn.onclick = toggleMode;
  fullViewBtn.onclick = toggleFullView;
  onboardingNextBtn.onclick = nextOnboardingStep;
  onboardingInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') nextOnboardingStep();
  });

  buildPinpad();
  setModeUI();
  updateOnboardingStep();
  appendLog('Secure gateway initialized. Awaiting onboarding sequence...', 'info');
</script>
</body>
</html>
